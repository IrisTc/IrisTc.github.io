<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实验一报告：Linux内核编译及添加系统调用 | Iris&#39;s notebook</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="学习记录与总结">
    
    <link rel="preload" href="/assets/css/0.styles.b607c32c.css" as="style"><link rel="preload" href="/assets/js/app.e6c7c4dd.js" as="script"><link rel="preload" href="/assets/js/2.e6ccdba6.js" as="script"><link rel="preload" href="/assets/js/35.c13b2ad5.js" as="script"><link rel="prefetch" href="/assets/js/10.b8b5d1d4.js"><link rel="prefetch" href="/assets/js/11.e6c27ae0.js"><link rel="prefetch" href="/assets/js/12.200b17e9.js"><link rel="prefetch" href="/assets/js/13.1b66e360.js"><link rel="prefetch" href="/assets/js/14.6e1cba7d.js"><link rel="prefetch" href="/assets/js/15.e0c9fb50.js"><link rel="prefetch" href="/assets/js/16.7b163ee6.js"><link rel="prefetch" href="/assets/js/17.e59bb99d.js"><link rel="prefetch" href="/assets/js/18.5fe9cc7a.js"><link rel="prefetch" href="/assets/js/19.768c665a.js"><link rel="prefetch" href="/assets/js/20.c67cb0e5.js"><link rel="prefetch" href="/assets/js/21.b2e4f6a3.js"><link rel="prefetch" href="/assets/js/22.1eb0447c.js"><link rel="prefetch" href="/assets/js/23.2d3c2dbf.js"><link rel="prefetch" href="/assets/js/24.9859a060.js"><link rel="prefetch" href="/assets/js/25.c9d04017.js"><link rel="prefetch" href="/assets/js/26.c4f0effd.js"><link rel="prefetch" href="/assets/js/27.8d760eb1.js"><link rel="prefetch" href="/assets/js/28.1cc7c407.js"><link rel="prefetch" href="/assets/js/29.726bb1a8.js"><link rel="prefetch" href="/assets/js/3.9a705177.js"><link rel="prefetch" href="/assets/js/30.aea8d770.js"><link rel="prefetch" href="/assets/js/31.15506b53.js"><link rel="prefetch" href="/assets/js/32.15d7f900.js"><link rel="prefetch" href="/assets/js/33.015155a9.js"><link rel="prefetch" href="/assets/js/34.dac1be22.js"><link rel="prefetch" href="/assets/js/36.2aba91aa.js"><link rel="prefetch" href="/assets/js/37.1bc3f5be.js"><link rel="prefetch" href="/assets/js/38.6d0e1316.js"><link rel="prefetch" href="/assets/js/39.2bec7c17.js"><link rel="prefetch" href="/assets/js/4.32fa7222.js"><link rel="prefetch" href="/assets/js/40.cad0a8f0.js"><link rel="prefetch" href="/assets/js/41.8f70d6a8.js"><link rel="prefetch" href="/assets/js/42.29c27b5d.js"><link rel="prefetch" href="/assets/js/5.bbf8cec9.js"><link rel="prefetch" href="/assets/js/6.91b7b8ed.js"><link rel="prefetch" href="/assets/js/7.27b7c40e.js"><link rel="prefetch" href="/assets/js/8.af5209be.js"><link rel="prefetch" href="/assets/js/9.f85e0862.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b607c32c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Iris's notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/IrisTc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/IrisTc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大三上课程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>大二下课程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Wto</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>创新实践</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>微信应用开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>操作系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/大二下课程/操作系统/实验一报告.html" class="active sidebar-link">实验一报告：Linux内核编译及添加系统调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#实验一报告-linux内核编译及添加系统调用" class="sidebar-link">实验一报告：Linux内核编译及添加系统调用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#一、实验目的" class="sidebar-link">一、实验目的</a></li><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#二、实验内容" class="sidebar-link">二、实验内容</a></li><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#三、设计方案" class="sidebar-link">三、设计方案</a></li><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#四、实验过程" class="sidebar-link">四、实验过程</a></li><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#五、实验测试" class="sidebar-link">五、实验测试</a></li><li class="sidebar-sub-header"><a href="/大二下课程/操作系统/实验一报告.html#六、问题记录和总结" class="sidebar-link">六、问题记录和总结</a></li></ul></li></ul></li><li><a href="/大二下课程/操作系统/实验二报告.html" class="sidebar-link">实验一报告：Linux内核模块编程</a></li><li><a href="/大二下课程/操作系统/实验五报告.html" class="sidebar-link">实验五报告：简单文件系统的实现</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>软件测试与分析</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="实验一报告-linux内核编译及添加系统调用"><a href="#实验一报告-linux内核编译及添加系统调用" class="header-anchor">#</a> 实验一报告：Linux内核编译及添加系统调用</h2> <p><em>陶莎 18271407</em></p> <h3 id="一、实验目的"><a href="#一、实验目的" class="header-anchor">#</a> 一、实验目的</h3> <p>Linux是开源操作系统，用户可以根据自身系统需要裁剪、修改内核，定制出功能更加合适、运行效率更高的系统，因此，编译Linux内核是进行内核开发的必要基本功。在系统中根据需要添加新的系统调用是修改内核的一种常用手段，通过本次实验，学生应理解Linux系统处理系统调用的流实验一报告：Linux内核编译及添加系统调用</p> <h3 id="二、实验内容"><a href="#二、实验内容" class="header-anchor">#</a> 二、实验内容</h3> <ul><li><p>（1）添加一个系统调用,实现对指定进程的nice值的修改或读取功能,并返回进程最新的 nice 值及优先级 prio。建议调用原型为:</p> <div class="language- extra-class"><pre class="language-text"><code>int mysetnice(pid_t pid, int flag, int nicevalue, void __user * prio, void __user * nice)
</code></pre></div><p>参数含义：</p> <div class="language- extra-class"><pre class="language-text"><code>pid:进程 ID。
nicevalue：为指定进程设置的新nice值。
flag:若值为 0,表示读取 nice 值;若值为 1,表示修改 nice 值。
prio、nice:进程当前优先级及 nice 值。返回值:系统调用成功时返回 0,失败时返回错误码 EFAULT
</code></pre></div></li> <li><p>(2)写一个简单的应用程序测试(1)中添加的系统调用。</p></li> <li><p>(3)若程序中调用了Linux的内核函数,要求深入阅读相关函数源码。</p></li></ul> <h3 id="三、设计方案"><a href="#三、设计方案" class="header-anchor">#</a> 三、设计方案</h3> <p>这个系统调用需要对指定进程的nice值进行修改和读取，同时也要返回进程最新的nice值及优先级prio，分成以下功能：</p> <ul><li>根据进程索引pid找到对应的进程控制块PCB</li> <li>根据PCB读取它的nice值和优先级prio</li> <li>根据PCB对相应进程的nice值进行修改</li> <li>将得到的nice值和优先级prio进程返回</li></ul> <p><img src="C:%5CUsers%5CTC%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1587387205211.png" alt="1587387205211"></p> <h3 id="四、实验过程"><a href="#四、实验过程" class="header-anchor">#</a> 四、实验过程</h3> <ul><li><p><strong>添加系统调用号</strong></p> <p><code>arch/x86/entry/syscalls/syscall_64.tbl</code></p> <table><thead><tr><th>系统调用号</th> <th>应用二进制接口</th> <th>系统调用名称</th> <th>服务例程入口</th></tr></thead> <tbody><tr><td>333</td> <td>64</td> <td>mysetnice</td> <td>sys_mysetnice</td></tr></tbody></table></li> <li><p><strong>系统调用原型</strong></p> <div class="language-c extra-class"><pre class="language-c"><code>asmlinkage <span class="token keyword">long</span> <span class="token function">sys_mysetnice</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> nicevalue<span class="token punctuation">,</span> <span class="token keyword">void</span> __user<span class="token operator">*</span> prio<span class="token punctuation">,</span> <span class="token keyword">void</span> __user<span class="token operator">*</span> nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>系统调用服务例程</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">SYSCALL_DEFINE5</span><span class="token punctuation">(</span>mysetnice<span class="token punctuation">,</span> <span class="token class-name">pid_t</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> nicevalue<span class="token punctuation">,</span> <span class="token keyword">void</span> __user<span class="token operator">*</span><span class="token punctuation">,</span> prio<span class="token punctuation">,</span> <span class="token keyword">void</span> __user<span class="token operator">*</span><span class="token punctuation">,</span> nice<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>ppid<span class="token punctuation">;</span>                      
    <span class="token comment">//进程描述符指针，指向一个枚举类型</span>
    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>task<span class="token punctuation">;</span>             <span class="token comment">//任务描述符信息</span>
    ppid <span class="token operator">=</span> <span class="token function">find_get_pid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//通过索引pid_t返回pid</span>
    task <span class="token operator">=</span> <span class="token function">pid_task</span><span class="token punctuation">(</span>ppid<span class="token punctuation">,</span> PIDTYPE_PID<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//通过pid返回进程task</span>

    <span class="token keyword">int</span> curr_nice<span class="token punctuation">;</span>
    curr_nice <span class="token operator">=</span> <span class="token function">task_nice</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回当前进程的nice值</span>
    <span class="token keyword">int</span> curr_prio<span class="token punctuation">;</span>
    curr_prio <span class="token operator">=</span> <span class="token function">task_prio</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//返回当前进程的prio值</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>           <span class="token comment">//如果flag等于1修改进程的nice值   </span>
        <span class="token function">set_user_nice</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> nicevalue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_nice <span class="token operator">=</span> <span class="token function">task_nice</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//重新获取修改过的nice值</span>
        curr_prio <span class="token operator">=</span> <span class="token function">task_prio</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//重新获取修改过的prio值    </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token comment">//如果flag不等于1或者0返回错误码</span>
        <span class="token keyword">return</span> EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">copy_to_user</span><span class="token punctuation">(</span>nice<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curr_nice<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>curr_nice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">//将nice值拷贝到用户空间</span>
    <span class="token function">copy_to_user</span><span class="token punctuation">(</span>prio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>curr_prio<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>curr_prio<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">//将prio值拷贝到用户空间</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>编译内核</p> <p><code>make menuconfig</code></p> <p><code>make</code></p> <p><code>make modules</code></p> <p><code>make modules_install</code></p> <p><code>make install</code></p> <p><code>update-grub2</code></p></li></ul> <h3 id="五、实验测试"><a href="#五、实验测试" class="header-anchor">#</a> 五、实验测试</h3> <ul><li><p>用户态测试程序</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/syscall.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_SYS_TSSETNICE_</span> <span class="token expression"><span class="token number">333</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EFAULT</span> <span class="token expression"><span class="token number">14</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> pid<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> nicevalue<span class="token punctuation">;</span>
    <span class="token keyword">int</span> prev_prio<span class="token punctuation">,</span> prev_nice<span class="token punctuation">,</span> curr_prio<span class="token punctuation">,</span> curr_nice<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, this is TS's syscall test...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Please input variable like this: pid, flag(0/1), nicevalue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%d%d%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>flag<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nicevalue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> <span class="token function">syscall</span><span class="token punctuation">(</span>_SYS_TSSETNICE_<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nicevalue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_prio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_nice<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> EFAULT<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">syscall</span><span class="token punctuation">(</span>_SYS_TSSETNICE_<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nicevalue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_prio<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Original priority is %d, Original nice is %d\n&quot;</span><span class="token punctuation">,</span> prev_prio<span class="token punctuation">,</span> prev_nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Current priority is %d, Current nice is %d\n&quot;</span><span class="token punctuation">,</span> curr_prio<span class="token punctuation">,</span> curr_nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Current priority is %d, Current nice is %d\n&quot;</span><span class="token punctuation">,</span> curr_prio<span class="token punctuation">,</span> curr_nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;flag is not exist\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>查看当前终端的进程pid号，选择flag=0查看当前nice和prio值</p> <p><img src="G:%5C%E6%88%AA%E5%9B%BE%5C%E6%88%AA%E5%9B%BE%5C990.PNG" alt="990"></p></li> <li><p>选择flag=1修改nice和prio值</p> <p><img src="G:%5C%E6%88%AA%E5%9B%BE%5C%E6%88%AA%E5%9B%BE%5C989.PNG" alt="989"></p></li></ul> <h3 id="六、问题记录和总结"><a href="#六、问题记录和总结" class="header-anchor">#</a> 六、问题记录和总结</h3> <ul><li><p>编译完成后版本不变的问题</p> <ul><li><p>检查grub.cfg文件，发现新的内核信息已经完全编译好并写入了，但是重启之后还是原来的版本，并没有被我新编译的内核替换</p></li> <li><p>原因：我编译的内核版本比下载的Ubuntu自带的内核版本低，所以还是启动的高版本内核，可以通过修改grub的配置选项， 将开机选择内核版本的菜单栏显示出来（默认是不显示，通过修改配置文件显示）</p> <div class="language- extra-class"><pre class="language-text"><code>//etc/default/grub

#GRUB_HIDDEN_TIMEOUT  //此配置将影响grub菜单显示。若设置此选项为一个常数，则将在此时间内隐藏菜单而显示引导画面。菜单将会被隐藏，如果注释掉该行，则grub菜单能够显示，等待用户的选择，以决定进入哪个系统或内核。
</code></pre></div></li></ul></li> <li><p>make -jn</p> <p>看实验书上有些在make后面加上-j可以加快编译速度，结果我加了之后总是编译失败会卡住然后黑屏，一直以为是我系统没装好的锅，重装了好几次虚拟机，后来查资料才发现后面还要加上n，以后遇到问题一定不能空想，白白浪费时间</p></li> <li><p>看源码想刨根问底</p> <ul><li>我会把用到的函数找出来看，然后不出意外里面还是嵌套了很多函数的，简直是无穷无尽，而且很多也想不懂最底层是怎么实现的，非常茫然</li> <li>但是其实后来查资料看到很多优秀的学习分享，大家也没有像我这样非要找出最底层的代码，其实了解这个函数由哪些功能构成应该就可以了，既然底层都写好了api了，那就直接用好了</li></ul></li></ul> <h4 id="附-相关源码"><a href="#附-相关源码" class="header-anchor">#</a> 附：相关源码</h4> <ul><li><p>通过索引找到pid</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span><span class="token function">find_get_pid</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span> nr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>pid<span class="token punctuation">;</span>

    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    			<span class="token comment">//RCU（同步机制）读过程开始</span>
    pid <span class="token operator">=</span> <span class="token function">get_pid</span><span class="token punctuation">(</span><span class="token function">find_vpid</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token comment">//通过find_vpid(nr) 来找到进程描述符(应该是遍历表找到)</span>
    <span class="token comment">//然后通过get_pid来让count字段加1</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//RCU读过程结束</span>

    <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>通过pid找到task</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token function">pid_task</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pid</span> <span class="token operator">*</span>pid<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">pid_type</span> type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> <span class="token operator">*</span>first<span class="token punctuation">;</span>
        first <span class="token operator">=</span> <span class="token function">rcu_dereference_check</span><span class="token punctuation">(</span><span class="token function">hlist_first_rcu</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token operator">-&gt;</span>tasks<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">lockdep_tasklist_lock_is_held</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span>
            result <span class="token operator">=</span> <span class="token function">hlist_entry</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">,</span> pids<span class="token punctuation">[</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>返回task的prio和nice</p> <ul><li>static_prio是静态优先级，不会随时间改变，内核不会主动修改，只能通过系统调用修改nice值去修改它，static_prio = MAX_RT_PRIO + nice +20, MAX_RT_PRIO的值为100，nice的范围为-20~19，值越小静态优先级越高；如果进程为非实时进程则prio = static_prio；若进程为非实时进程，则prio = MAX_TR_PRIO -1 - rt_priority，实施优先级越大进程优先级越高</li> <li>realtime任务的调度优先级永远高于所有的非realtime任务，即非实时任务只有在没有任何实时任务运行时才可能被运行。</li> <li>task_struct的prio成员取值范围是0~139，值越小，优先级越高，也就是prio为0的task具有最高优先级（idle task），而 task_prio函数返回的值，对应的范围是-100到39 ，可以看到减去了100</li></ul> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">task_nice</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">PRIO_TO_NICE</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-&gt;</span>static_prio<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">//从进程task_struct结构中获得静态优先级static_prio，然后通过PRIO_TO_NICE宏将其转化成nice值</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">task_prio</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> p<span class="token operator">-&gt;</span>prio <span class="token operator">-</span> MAX_RT_PRIO<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>更改nice值</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">set_user_nice</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">long</span> nice<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool queued<span class="token punctuation">,</span> running<span class="token punctuation">;</span>
    <span class="token keyword">int</span> old_prio<span class="token punctuation">,</span> delta<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rq_flags</span> rf<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">rq</span> <span class="token operator">*</span>rq<span class="token punctuation">;</span>

    <span class="token comment">//如果nice值的范围不在-20~19之间，直接退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">task_nice</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">==</span> nice <span class="token operator">||</span> nice <span class="token operator">&lt;</span> MIN_NICE <span class="token operator">||</span> nice <span class="token operator">&gt;</span> MAX_NICE<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * We have to be careful, if called from sys_setpriority(),
     * the task might be in the middle of scheduling on another CPU.
     */</span>
    rq <span class="token operator">=</span> <span class="token function">task_rq_lock</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">update_rq_clock</span><span class="token punctuation">(</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * The RT priorities are set via sched_setscheduler(), but we still
     * allow the 'normal' nice value to be set - but as expected
     * it wont have any effect on scheduling until the task is
     * SCHED_DEADLINE, SCHED_FIFO or SCHED_RR:
     */</span>
    <span class="token comment">//针对实时进程设置nice值，将nice值转成优先级后设置到p-&gt;static_prio </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">task_has_dl_policy</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">task_has_rt_policy</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p<span class="token operator">-&gt;</span>static_prio <span class="token operator">=</span> <span class="token function">NICE_TO_PRIO</span><span class="token punctuation">(</span>nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_unlock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    queued <span class="token operator">=</span> <span class="token function">task_on_rq_queued</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    running <span class="token operator">=</span> <span class="token function">task_current</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queued<span class="token punctuation">)</span>
        <span class="token function">dequeue_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">,</span> DEQUEUE_SAVE <span class="token operator">|</span> DEQUEUE_NOCLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span>
        <span class="token function">put_prev_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">//将nice值转成优先级设置到static_prio 中</span>
    p<span class="token operator">-&gt;</span>static_prio <span class="token operator">=</span> <span class="token function">NICE_TO_PRIO</span><span class="token punctuation">(</span>nice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_load_weight</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    old_prio <span class="token operator">=</span> p<span class="token operator">-&gt;</span>prio<span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>prio <span class="token operator">=</span> <span class="token function">effective_prio</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    delta <span class="token operator">=</span> p<span class="token operator">-&gt;</span>prio <span class="token operator">-</span> old_prio<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>queued<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enqueue_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">,</span> ENQUEUE_RESTORE <span class="token operator">|</span> ENQUEUE_NOCLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * If the task increased its priority or is running and
         * lowered its priority, then reschedule its CPU:
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>delta <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">task_running</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">resched_curr</span><span class="token punctuation">(</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span>
        <span class="token function">set_curr_task</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_unlock<span class="token operator">:</span>
    <span class="token function">task_rq_unlock</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>将内核态传递给用户态</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token keyword">volatile</span> <span class="token operator">*</span>to<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
                   <span class="token keyword">unsigned</span> <span class="token keyword">long</span> n<span class="token punctuation">)</span> 
<span class="token comment">//*to是内核空间的指针，*from是用户空间指针，n表示从用户空间想内核空间拷贝数据的字节数</span>
<span class="token punctuation">{</span>
    <span class="token function">__chk_user_ptr</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">volatile_memcpy</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/21/2020, 2:15:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/大二下课程/微信应用开发/小程序调研_用户角度.html" class="prev">
        基于用户角度的小程序调研
      </a></span> <span class="next"><a href="/大二下课程/操作系统/实验二报告.html">
        实验一报告：Linux内核模块编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e6c7c4dd.js" defer></script><script src="/assets/js/2.e6ccdba6.js" defer></script><script src="/assets/js/35.c13b2ad5.js" defer></script>
  </body>
</html>
